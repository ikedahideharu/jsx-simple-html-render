"use strict";var __spreadArray=this&&this.__spreadArray||function(e,t){for(var r=0,i=t.length,o=e.length;r<i;r++,o++)e[o]=t[r];return e},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),require("@babel/register");var chokidar_1=__importDefault(require("chokidar")),fs_extra_1=require("fs-extra"),replaceList_1=require("./replaceList"),JSXDependencyTree_1=require("./JSXDependencyTree"),utility_1=require("./utility"),env=process.env.NODE_ENV;process.env.NODE_ENV="development";var renderToStaticMarkup=require("react-dom/server").renderToStaticMarkup;process.env.NODE_ENV=env;var JsxSimpleHtmlRender=function(){function e(e){var t=e.throwFlag,r=e.watch,i=e.src,o=e.relativeRoot,a=e.output,e=e.replace;this.replace=void 0===e?[]:e,this.throwFlag=t,this.relativeRoot=o,this.src=utility_1.makeFullPath(i),this.output=utility_1.makeFullPath(a),r?(this.DTI=new JSXDependencyTree_1.JSXDependencyTree(this.src),this.exportHTML(this.DTI.tree),this.watch()):this.exportHTML(utility_1.getJSXFilePaths(this.src,!0))}return e.prototype.watch=function(){var t=this,e=chokidar_1.default.watch(this.src,{persistent:!0});e.on("ready",function(){e.on("change",function(e){t.exportHTML(t.DTI.findDependencyFiles(e))}),e.on("add",function(e){t.exportHTML(t.DTI.setTree(e))}),e.on("unlink",function(e){t.DTI.removeDependency(e)})})},e.prototype.getOutputPath=function(e){return e.replace(this.src,this.output).replace(/\.jsx/,".html")},e.prototype.exportHTML=function(e){utility_1.log.y("> export html");var t=process.env.NODE_ENV;process.env.NODE_ENV="development";var r,i,o=utility_1.errorHook();for(r in e)e.hasOwnProperty(r)&&(i=this.getOutputPath(r),fs_extra_1.outputFileSync(i,this.getHTML(renderToStaticMarkup,r,this.getRelativePath(i))));o.detach(),process.env.NODE_ENV=t},e.prototype.getRelativePath=function(e){var e=e.split("/"),t=e.length-e.indexOf(this.relativeRoot)-1,r="";if(1==t)return r;for(var i=1;i<t;i++)r+="../";return r},e.prototype.getHTML=function(e,t,r){try{var i=this.codeReplace(e(require(t).default({relativePath:r})));return utility_1.log.b(t),i}catch(e){if(utility_1.log.r(t),utility_1.log.r(e),this.throwFlag)throw"";return"Error"}},e.prototype.codeReplace=function(e){return utility_1.replaceLoop(e,0===this.replace.length?replaceList_1.replaceList:__spreadArray(__spreadArray([],replaceList_1.replaceList),this.replace))},e.prototype.apply=function(){},e}();module.exports=JsxSimpleHtmlRender;